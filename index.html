<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sapinover LLC | Overnight Trading Analysis</title>
    <meta name="description" content="Institutional-grade overnight equity trading research and market microstructure analysis by Sapinover LLC.">

    <!-- Favicon -->
    <link rel="icon" type="image/png" href="FullLogo_NoBuffer__1_.png">

    <!-- Chart.js for bar/line/radar charts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>

    <!-- Plotly for scatter, heatmaps, distributions -->
    <script src="https://cdn.plot.ly/plotly-2.26.0.min.js"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Source+Serif+4:wght@400;600;700&family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Dashboard Styles -->
    <link rel="stylesheet" href="styles.css?v=4.1">
</head>
<body>
    <!-- Loading Progress Bar -->
    <div class="loading-bar" id="loadingBar" style="width: 0%"></div>

    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div class="header-left">
                <img src="FullLogo_NoBuffer__1_.png" alt="Sapinover LLC" class="logo-img">
                <div class="header-title">
                    <h1>Overnight Trading Analysis</h1>
                    <span class="subtitle">Quantitative Market Microstructure Research</span>
                </div>
            </div>
            <div class="header-meta">
                <div class="date-range" id="dateRangeDisplay">Loading...</div>
                <div id="generatedDisplay">Generated: --</div>
            </div>
        </div>
    </header>

    <!-- Tab Navigation -->
    <nav class="tab-nav" role="tablist" aria-label="Dashboard sections">
        <div class="tab-nav-container">
            <button class="tab-btn active" data-tab="summary" role="tab" aria-selected="true" aria-controls="tab-summary">
                <i class="fas fa-chart-line"></i> Summary
            </button>
            <button class="tab-btn" data-tab="daily" role="tab" aria-selected="false" aria-controls="tab-daily">
                <i class="fas fa-calendar-day"></i> Daily
            </button>
            <button class="tab-btn" data-tab="structure" role="tab" aria-selected="false" aria-controls="tab-structure">
                <i class="fas fa-pie-chart"></i> Structure
            </button>
            <button class="tab-btn" data-tab="quadrant" role="tab" aria-selected="false" aria-controls="tab-quadrant">
                <i class="fas fa-bullseye"></i> Quadrant
            </button>
            <button class="tab-btn" data-tab="explorer" role="tab" aria-selected="false" aria-controls="tab-explorer">
                <i class="fas fa-table"></i> Explorer
            </button>
            <button class="tab-btn" data-tab="clustering" role="tab" aria-selected="false" aria-controls="tab-clustering">
                <i class="fas fa-project-diagram"></i> Clustering
            </button>
            <button class="tab-btn" data-tab="correlation" role="tab" aria-selected="false" aria-controls="tab-correlation">
                <i class="fas fa-th"></i> Heatmaps
            </button>
            <button class="tab-btn" data-tab="risk" role="tab" aria-selected="false" aria-controls="tab-risk">
                <i class="fas fa-shield-halved"></i> Risk
            </button>
            <button class="tab-btn" data-tab="timeseries" role="tab" aria-selected="false" aria-controls="tab-timeseries">
                <i class="fas fa-wave-square"></i> Regimes
            </button>
            <button class="tab-btn" data-tab="screener" role="tab" aria-selected="false" aria-controls="tab-screener">
                <i class="fas fa-filter"></i> Screener
            </button>
            <button class="tab-btn" data-tab="asiasleeps" role="tab" aria-selected="false" aria-controls="tab-asiasleeps">
                <i class="fas fa-moon"></i> Asia Sleeps
            </button>
            <button class="tab-btn" data-tab="methodology" role="tab" aria-selected="false" aria-controls="tab-methodology">
                <i class="fas fa-book"></i> Methodology
            </button>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="main" id="mainContent">
        <div class="loading" role="status">
            <div class="loading-spinner"></div>
            <span>Loading data...</span>
        </div>
    </main>

    <!-- Position Detail Modal -->
    <div class="modal" id="positionModal" role="dialog" aria-modal="true" aria-labelledby="modalSymbol">
        <div class="modal-content">
            <div class="modal-header">
                <div>
                    <h2 id="modalSymbol">--</h2>
                    <h3 id="modalCompany">--</h3>
                </div>
                <button class="modal-close" onclick="closeModal()" aria-label="Close modal">&times;</button>
            </div>
            <div id="modalBody"></div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <span class="footer-brand">Sapinover LLC</span> · Market Microstructure Research ·
        <span id="footerYear">2026</span>
        · <a href="metrics-guide.html" style="color: #f5a623; text-decoration: none;">Metrics Guide</a>
    </footer>

    <!-- Login Overlay -->
    <div id="loginOverlay" style="
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: #0a0a0a; z-index: 9999;
        display: flex; align-items: center; justify-content: center;
        font-family: 'Outfit', 'Inter', sans-serif;
    ">
        <div style="text-align: center; max-width: 400px; padding: 40px;">
            <img src="FullLogo_NoBuffer__1_.png" alt="Sapinover LLC" style="height: 36px; margin-bottom: 24px; opacity: 0.9;">
            <h2 style="font-family: 'Source Serif 4', serif; font-size: 1.6rem; color: #f0f0f2; margin-bottom: 6px;">
                Overnight Trading Analysis
            </h2>
            <p style="color: #8a8a96; font-size: 0.85rem; letter-spacing: 0.1em; text-transform: uppercase; margin-bottom: 32px;">
                Authorized Access Only
            </p>
            <form id="loginForm" onsubmit="handleLogin(event)" style="display: flex; flex-direction: column; gap: 12px;">
                <input type="password" id="passwordInput" placeholder="Enter password"
                    autocomplete="current-password"
                    style="
                        padding: 12px 16px; border-radius: 8px;
                        border: 1px solid #1e1e24; background: #141418;
                        color: #f0f0f2; font-size: 1rem;
                        font-family: 'JetBrains Mono', monospace;
                        outline: none; text-align: center;
                    "
                    onfocus="this.style.borderColor='#f5a623'" onblur="this.style.borderColor='#1e1e24'"
                >
                <button type="submit" id="loginBtn" style="
                    padding: 12px 24px; border-radius: 8px; border: none;
                    background: #f5a623; color: #0a0a0a;
                    font-size: 0.95rem; font-weight: 600;
                    cursor: pointer; transition: opacity 0.2s;
                " onmouseover="this.style.opacity='0.85'" onmouseout="this.style.opacity='1'">
                    Access Dashboard
                </button>
            </form>
            <p id="loginError" style="color: #ef5350; font-size: 0.85rem; margin-top: 12px; display: none;">
                Invalid password. Please try again.
            </p>
            <p id="loginStatus" style="color: #8a8a96; font-size: 0.82rem; margin-top: 12px; display: none;">
                Decrypting data...
            </p>
        </div>
    </div>

    <script src="dashboard.js?v=4.2"></script>

    <!-- Auth + Decryption Script -->
    <script>
    const PBKDF2_ITERATIONS = 100000;

    async function deriveKey(password, salt) {
        const enc = new TextEncoder();
        const keyMaterial = await crypto.subtle.importKey(
            'raw', enc.encode(password), 'PBKDF2', false, ['deriveKey']
        );
        return crypto.subtle.deriveKey(
            { name: 'PBKDF2', salt: salt, iterations: PBKDF2_ITERATIONS, hash: 'SHA-256' },
            keyMaterial,
            { name: 'AES-GCM', length: 256 },
            false,
            ['decrypt']
        );
    }

    async function decryptData(password) {
        const response = await fetch('data.enc');
        if (!response.ok) throw new Error('Could not load encrypted data');
        const b64 = await response.text();

        // Decode base64
        const raw = Uint8Array.from(atob(b64), c => c.charCodeAt(0));

        // Extract salt(16) + iv(12) + ciphertext+tag
        const salt = raw.slice(0, 16);
        const iv = raw.slice(16, 28);
        const ciphertext = raw.slice(28);

        // Derive key and decrypt
        const key = await deriveKey(password, salt);
        const decrypted = await crypto.subtle.decrypt(
            { name: 'AES-GCM', iv: iv },
            key,
            ciphertext
        );

        const text = new TextDecoder().decode(decrypted);
        return JSON.parse(text);
    }

    async function handleLogin(e) {
        if (e) e.preventDefault();
        const password = document.getElementById('passwordInput').value;
        if (!password) return;

        const errorEl = document.getElementById('loginError');
        const statusEl = document.getElementById('loginStatus');
        const btnEl = document.getElementById('loginBtn');

        errorEl.style.display = 'none';
        statusEl.style.display = 'block';
        statusEl.textContent = 'Decrypting data...';
        btnEl.disabled = true;
        btnEl.textContent = 'Decrypting...';

        try {
            const json = await decryptData(password);

            // Save to session
            sessionStorage.setItem('sp_auth', password);

            // Hide overlay
            document.getElementById('loginOverlay').style.display = 'none';

            // Initialize dashboard with decrypted data
            window.initDashboard(json);
        } catch (err) {
            errorEl.style.display = 'block';
            statusEl.style.display = 'none';
            btnEl.disabled = false;
            btnEl.textContent = 'Access Dashboard';
            document.getElementById('passwordInput').value = '';
            document.getElementById('passwordInput').focus();
        }
    }

    // Check session on page load
    document.addEventListener('DOMContentLoaded', async () => {
        const saved = sessionStorage.getItem('sp_auth');
        if (saved) {
            try {
                const json = await decryptData(saved);
                document.getElementById('loginOverlay').style.display = 'none';
                window.initDashboard(json);
            } catch {
                sessionStorage.removeItem('sp_auth');
            }
        } else {
            document.getElementById('passwordInput').focus();
        }
    });
    </script>
</body>
</html>
